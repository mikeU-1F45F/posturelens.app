# Session Notes — 2026-02-08

## What we accomplished

### 1) Centralized alerting (shared mechanisms)
- Implemented an `AlertEngine` that is used by both face-touch and posture detection.
- Alert behaviors (MVP spec):
  - Normal confidence: red background flash + short beep + red toast with reason.
  - Low confidence: yellow background flash only (no audio, no toast).
  - Global cooldown: 60s in prod; 5s on localhost.

### 2) Face-touch proximity detection
- Implemented hand→face proximity detection in `src/core/proximity.ts`.
- Wired it to `AlertEngine` with reason `"Hands near face"`.
- Added Z-depth gating (`|handZ - faceZ|`) to reduce false positives when the hand is simply closer to the camera.

### 3) Posture deviation detection (ratio-based)
- Implemented posture deviation detection in `src/core/posture.ts` using the shoulder-triangle ratio vs the captured reference.
- Implemented a head-tilt guard signal (nose-to-shoulder-midpoint Y delta) used to downgrade confidence.

### 4) Sensitivity controls (Low/Medium/High)
- Added two sensitivity dropdowns (persisted to `localStorage`):
  - Face-touch sensitivity
  - Posture sensitivity
- Switching sensitivity updates the detector thresholds immediately.

### 5) Debug fix: dev server / service worker stale bundle
- Root cause of “no alerts”: the service worker could serve a cached, stale `/main.js` during development.
- Fixes:
  - `dev-server.ts` now rebuilds `public/main.js` on request for `/main.js` and `/main.js.map`.
  - `public/sw.template.js` bypasses cache for `/main.js` and `/main.js.map` on localhost.

## Current issue: posture alerts not firing reliably
Face-touch alerts are working and sensitivity is adjustable. Posture alerts were reported as not firing at any sensitivity.

### Likely causes
- The ratio-based metric may not change enough for some camera setups, lighting, or user movement patterns.
- Posture detection state (smoothing/streak) can be disrupted if posture evaluation does not run consistently.
- The “head-tilt guard” may be downgrading confidence (yellow-only flash), which can be easy to miss.

### Fixes to implement next
1) Add targeted debug telemetry (console-only)
- Log (at `console.debug`) when posture is near/over threshold:
  - `refRatio`, `liveRatio`, computed threshold, bad streak count.
- Consider a dev-only optional status readout (not on the video canvas).

2) Improve the posture signal beyond ratio-only
- Add a second signal based on shoulder width change vs reference.
- Incorporate Z-coordinate reinforcement (average shoulder Z vs reference) as planned in TASKS.
- Consider an aggregated posture score (ratio + width + Z + head delta) with smoothing.

3) UX confirmation for low-confidence posture
- Consider a very subtle non-intrusive indicator (outside the video canvas) so yellow-only flashes are not missed.

## How to retest quickly
- Run `bun run dev`.
- Capture a reference pose.
- Confirm face-touch alerts fire with the new sensitivity controls.
- For posture: slouch/round shoulders forward for ~1–2 seconds and confirm whether any alert fires (red/yellow flash).
